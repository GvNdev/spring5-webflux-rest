# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: cimg/openjdk:21.0
      - image: mongo
        environment:
          MONGO_INITDB_DATABASE: test

    working_directory: ~/spring5-webflux-rest

    environment:
      # Customize the JVM maximum heap limit
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx3200m -Dfile.encoding=UTF-8"

    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-gradle-deps-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}
            # fallback to using the latest cache if no exact match is found
            - v2-gradle-deps-

      # Ensure Gradle wrapper is executable (sometimes needed on Linux containers)
      - run:
          name: Prepare Gradle wrapper
          command: |
            ls -la ./gradlew
            sed -i 's/\r$//' ./gradlew || true
            chmod +x ./gradlew
            ls -la ./gradlew

      # Warm up dependencies (similar intent to mvn dependency:go-offline
      - run:
          name: Warm Gradle dependencies
          command: bash ./gradlew --no-daemon dependencies || true

      - save_cache:
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
          key: v2-gradle-deps-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}

      - run:
          name: Wait for MongoDB
          command: |
            for i in $(seq 1 30); do
              (echo > /dev/tcp/localhost/27017) >/dev/null 2>&1 && echo "Mongo is up" && exit 0
              echo "Waiting for Mongo..."
              sleep 2
            done
            echo "Mongo did not start in time" && exit 1

      # Run tests + coverage (UT + IT) and generate merged JaCoCo XML
      - run:
          name: Test + Coverage (UT + IT)
          command: bash ./gradlew --no-daemon --no-configuration-cache clean check

      - run:
          name: Prepare JUnit test results
          command: |
            mkdir -p test-results/unit test-results/integration
            cp -v build/test-results/test/TEST-*.xml test-results/unit/ || true
            cp -v build/test-results/integrationTest/TEST-*.xml test-results/integration/ || true

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: build/reports/jacoco/jacoco.xml

      - run:
          name: Verify JaCoCo XML exists
          command: |
            ls -lah build/reports/jacoco || true
            test -f build/reports/jacoco/jacoco.xml

      - run:
          name: Upload coverage to Codecov (force GitHub repo slug)
          command: |
            REPO_URL="$(git remote get-url origin)"
            echo "origin=$REPO_URL"
            
            SLUG="$(echo "$REPO_URL" | sed -E 's#(https://github.com/|git@github.com:)([^/]+)/([^/.]+)(\.git)?#\2/\3#')"
            echo "slug=$SLUG"
            
            curl -Os https://cli.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov --version
            
            ./codecov --verbose upload-process \
              -t "$CODECOV_TOKEN" \
              -r "$SLUG" \
              -f "build/reports/jacoco/jacoco.xml"

      - run:
          name: Upload JUnit test results to CodeCov (Test Analytics)
          when: always
          command: |
            # Repo slug
            REPO_URL="$(git remote get-url origin)"
            echo "origin=$REPO_URL"
            SLUG="$(echo "$REPO_URL" | sed -E 's#(https://github.com/|git@github.com:)([^/]+)/([^/.]+)(\.git)?#\2/\3#')"
            echo "slug=$SLUG"
            
            # Descargar CodeCov CLI (binario)
            curl -Os https://cli.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov --version
            
            # Verifica que existan XML
            ls -lah build/test-results/test || true
            ls -lah build/test-results/integrationTest || true
            
            # Upload Unit tests (flag: unit)
            for f in build/test-results/test/TEST-*.xml; do
              [ -f "$f" ] || continue
              echo "Uploading unit test result: $f"
              ./codecov --verbose do-upload \
                -t "$CODECOV_TOKEN" \
                -r "$SLUG" \
                --report-type test_results \
                --file "$f" \
                --flag unit
            done

            # Upload Integration tests (flag: integration)
            for f in build/test-results/integrationTest/TEST-*.xml; do
              [ -f "$f" ] || continue
              echo "Uploading integration test result: $f"
              ./codecov --verbose do-upload \
                -t "$CODECOV_TOKEN" \
                -r "$SLUG" \
                --report-type test_results \
                --file "$f" \
                --flag integration
            done

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build